

db.posts.aggregate([
    {"$match": {"PostTypeId":"1"}},
    {"$project": {
                    "Id": 1,
                    "Title": 1,
                    "CreationDate": 1,
                    "Score": 1,
                    "AnswerCount": 1,
                    "terms": 1,
                    "tagarr": {         
                                "$split": [{"$substr": [
                                                    "$Tags",
                                                    1,
                                                    {"$subtract": [{"$strLenCP": "$Tags"}, 2]}
                                                ]
                                            },
                                            "><"]
                                }
                    }
    }])

    {"$match": { "$or": [ {"terms": {"$regex": kwStr, "$options": "i"}}, {"tagarr": {"$regex": kwStr, "$options": "i"}} ] }},
    {"$unwind": "$terms"},
    {"$unwind": "$tagarr"},
    {"$match": { "$or": [ {"terms": {"$regex": kwStr, "$options": "i"}}, {"tagarr": {"$regex": kwStr, "$options": "i"}} ] }},
    {"$group": {"_id": "$Id",
                "Title": {"$first": "$Title"},
                "CreationDate": {"$first": "$CreationDate"},
                "Score": {"$first": "$Score"},
                "AnswerCount": {"$first": "$AnswerCount"},
                "match": {"$sum": 1}}},
    {"$sort": {"match": -1}}
])

